import sys
import time
from urllib.request import Request, urlopen

import pymysql
from pymysql.constants import COMMAND

def insertData(datas):
    db = "stock"
    con = pymysql.connect(host="localhost", port=3306, user="root", password="123456", charset="utf8")
    try:
        print("open db:{}".format(db))
        con.select_db(db)
    except BaseException as err:
        print("create db:{}".format(db))
        con.cursor().execute("create database {}".format(db))
        con.select_db(db)
        con.cursor().execute('''create table s_300059 (
        id int primary key auto_increment comment 'id',
        date date comment 'date',
        start float comment 'start',
        end float comment 'end',
        max float comment 'max',
        );''')
    # for kLineData in datas:
        # con.cursor().execute("insert into {}(date,start,end,max,min,volume,quota,roc,change,tor) values({},{},{},{},{},{},{},{},{},{});".format(db, kLineData[0], kLineData[1], kLineData[2], kLineData[3], kLineData[4], kLineData[5], kLineData[6],kLineData[7],kLineData[8],kLineData[9]))
    con.cursor().close()
    con.close()

def getKLineDayUrl(id, t)->str:
    return "http://18.push2his.eastmoney.com/api/qt/stock/kline/get?cb=jQuery112408003210799893224_1596771552775&secid=0.{}&ut=fa5fd1943c7b386f172d6893dbfba10b&fields1=f1%2Cf2%2Cf3%2Cf4%2Cf5%2cf6%2cf7%2cf8&fields2=f51%2Cf52%2Cf53%2Cf54%2Cf55%2Cf56%2Cf57%2Cf58%2Cf59%2cf60%2cf61&klt=101&fqt=0&end=20500101&lmt=120&_={}".format(id, t)

def getData()->str:
    url = getKLineDayUrl(300059, int(time.time() * 1000))
    req = Request(url)
    respones = None
    try:
        respones = urlopen(url)
    except Exception as err:
        print("err:{}".format(err))
        sys.exit()
    data = respones.read()
    print(data)
    return data

# data = getData()
data = '''b'jQuery112408003210799893224_1596771552775({"rc":0,"rt":17,"svr":181669633,"lt":1,"full":0,"data":{"code":"300059","market":0,"name":"\xe4\xb8\x9c\xe6\x96\xb9\xe8\xb4\xa2\xe5\xaf\x8c","decimal":2,"dktotal":2462,"preKPrice":14.64,"prePrice":28.67,"qtMiscType":7,"klines":["2020-02-14,14.70,15.30,15.86,14.63,4275734,6545694464.00,8.40,4.51,0.66,7.85","2020-02-17,15.80,15.91,16.03,15.54,4114007,6499286016.00,3.20,3.99,0.61,7.55","2020-02-18,15.82,15.74,16.00,15.58,2520141,3974813872.00,2.64,-1.07,-0.17,4.63","2020-02-19,15.70,15.76,16.19,15.65,2839204,4526413056.00,3.43,0.13,0.02,5.21","2020-02-20,15.87,17.34,17.34,15.75,4794105,7938635008.00,10.09,10.03,1.58,8.80","2020-02-21,18.26,18.50,19.06,17.91,7966523,14695740928.00,6.63,6.69,1.16,14.63","2020-02-24,18.22,18.66,19.16,18.07,5275290,9823524608.00,5.89,0.86,0.16,9.69","2020-02-25,18.27,19.95,20.15,17.80,6379796,12030162176.00,12.59,6.91,1.29,11.71","2020-02-26,19.50,18.73,20.20,18.59,5873584,11393493248.00,8.07,-6.12,-1.22,10.78","2020-02-27,18.96,18.98,19.47,18.53,4134498,7870104320.00,5.02,1.33,0.25,7.59","2020-02-28,18.20,17.35,18.53,17.08,5711879,10227920640.00,7.64,-8.59,-1.63,10.49","2020-03-02,17.79,18.18,18.56,17.47,4604523,8301295872.00,6.28,4.78,0.83,8.45","2020-03-03,18.70,18.45,19.35,18.20,4298307,8048507648.00,6.33,1.49,0.27,7.89","2020-03-04,18.43,19.32,19.32,18.19,4199615,7863390464.00,6.12,4.72,0.87,7.71","2020-03-05,19.47,20.17,20.68,18.94,6029906,11924762880.00,9.01,4.40,0.85,11.07","2020-03-06,19.60,19.17,19.83,19.16,3577783,6953359872.00,3.32,-4.96,-1.00,6.57","2020-03-09,18.49,17.99,18.92,17.64,4763156,8689648640.00,6.68,-6.16,-1.18,8.75","2020-03-10,18.30,19.00,19.20,17.82,4383229,8114760192.00,7.67,5.61,1.01,8.05","2020-03-11,18.86,18.17,18.93,18.05,3274860,6057177856.00,4.63,-4.37,-0.83,6.01","2020-03-12,17.95,18.11,18.36,17.78,2833131,5115009536.00,3.19,-0.33,-0.06,5.20","2020-03-13,17.28,17.93,18.30,17.18,4015042,7097581312.00,6.18,-0.99,-0.18,7.37","2020-03-16,17.70,16.47,17.92,16.31,4252991,7273535744.00,8.98,-8.14,-1.46,7.81","2020-03-17,17.00,16.78,17.13,16.23,3210659,5380984320.00,5.46,1.88,0.31,5.90","2020-03-18,16.90,16.16,17.24,16.10,3289019,5522108928.00,6.79,-3.69,-0.62,6.04","2020-03-19,16.36,16.73,16.94,16.06,3483067,5747426048.00,5.45,3.53,0.57,6.40","2020-03-20,16.90,16.88,17.00,16.44,2503254,4196414624.00,3.35,0.90,0.15,4.60","2020-03-23,16.29,16.03,16.55,16.00,2287452,3720037504.00,3.26,-5.04,-0.85,4.20","2020-03-24,16.43,16.68,16.74,15.94,2758469,4526702336.00,4.99,4.05,0.65,5.07","2020-03-25,17.00,16.88,17.24,16.75,3164924,5377731328.00,2.94,1.20,0.20,5.81","2020-03-26,16.70,16.59,16.92,16.55,1668375,2790150944.00,2.19,-1.72,-0.29,3.06","2020-03-27,16.83,16.64,17.10,16.59,2074626,3488334608.00,3.07,0.30,0.05,3.81","2020-03-30,16.20,16.34,16.51,16.02,1800253,2920875936.00,2.94,-1.80,-0.30,3.31","2020-03-31,16.55,16.05,16.55,16.03,1609576,2621101712.00,3.18,-1.77,-0.29,2.96","2020-04-01,15.96,16.07,16.40,15.90,1582558,2563599696.00,3.12,0.12,0.02,2.91","2020-04-02,16.08,16.62,16.64,16.07,1934677,3159733312.00,3.55,3.42,0.55,3.55","2020-04-03,16.45,16.23,16.50,16.18,1552487,2534718400.00,1.93,-2.35,-0.39,2.85","2020-04-07,16.64,16.77,16.90,16.57,2360240,3948685280.00,2.03,3.33,0.54,4.33","2020-04-08,16.61,16.74,16.86,16.60,1371525,2291813696.00,1.55,-0.18,-0.03,2.52","2020-04-09,17.12,17.45,17.81,17.12,3490227,6103970816.00,4.12,4.24,0.71,6.41","2020-04-10,17.80,17.13,17.80,17.05,3044294,5292963328.00,4.30,-1.83,-0.32,5.59","2020-04-13,17.00,17.68,17.68,16.91,2364837,4094262640.00,4.50,3.21,0.55,4.34","2020-04-14,17.66,17.90,18.18,17.48,3068790,5457117952.00,3.96,1.24,0.22,5.63","2020-04-15,17.75,17.32,17.91,17.29,2427733,4274958912.00,3.46,-3.24,-0.58,4.46","2020-04-16,17.25,17.57,17.75,17.21,2068866,3629400544.00,3.12,1.44,0.25,3.80","2020-04-17,17.78,17.64,18.02,17.60,2678493,4769324800.00,2.39,0.40,0.07,4.92","2020-04-20,17.65,17.70,17.95,17.55,1685547,2990002928.00,2.27,0.34,0.06,3.09","2020-04-21,17.56,17.38,17.57,17.10,1880075,3258514000.00,2.66,-1.81,-0.32,3.45","2020-04-22,17.20,17.42,17.50,17.17,1557752,2700923840.00,1.90,0.23,0.04,2.86","2020-04-23,17.42,17.14,17.44,17.12,1271065,2190554512.00,1.84,-1.61,-0.28,2.33","2020-04-24,17.14,16.82,17.27,16.75,1581927,2684621248.00,3.03,-1.87,-0.32,2.90","2020-04-27,16.88,16.71,17.05,16.68,1356463,2290364848.00,2.20,-0.65,-0.11,2.49","2020-04-28,16.99,17.23,17.50,16.85,2740120,4713579776.00,3.89,3.11,0.52,5.03","2020-04-29,17.14,17.48,17.68,17.10,1953266,3413478432.00,3.37,1.45,0.25,3.59","2020-04-30,17.66,18.24,18.30,17.58,2906978,5250878208.00,4.12,4.35,0.76,5.34","2020-05-06,17.95,18.42,18.44,17.88,2499949,4534067200.00,3.07,0.99,0.18,4.59","2020-05-07,18.32,18.14,18.47,18.05,1712024,3122081568.00,2.28,-1.52,-0.28,3.14","2020-05-08,18.33,18.40,18.83,18.22,2647392,4890339328.00,3.36,1.43,0.26,4.86","2020-05-11,18.35,18.25,18.60,18.09,1868459,3427094192.00,2.77,-0.82,-0.15,3.43","2020-05-12,18.28,18.20,18.39,17.93,1288661,2339150976.00,2.52,-0.27,-0.05,2.37","2020-05-13,18.11,18.25,18.34,18.04,1174428,2138373104.00,1.65,0.27,0.05,2.16","2020-05-14,18.12,17.89,18.20,17.88,1255429,2263708752.00,1.75,-1.97,-0.36,2.30","2020-05-15,18.04,17.91,18.15,17.90,1086825,1958549504.00,1.40,0.11,0.02,1.99","2020-05-18,17.90,18.03,18.28,17.72,1614241,2915712880.00,3.13,0.67,0.12,2.96","2020-05-19,18.32,18.26,18.49,18.23,1591316,2915452352.00,1.44,1.28,0.23,2.92","2020-05-20,18.20,17.95,18.25,17.86,1258916,2274510672.00,2.14,-1.70,-0.31,2.31","2020-05-21,15.03,14.68,15.06,14.61,1533815,2271074704.00,2.51,-18.22,-3.27,2.34","2020-05-22,14.65,14.19,14.71,14.16,1736694,2500179536.00,3.75,-3.34,-0.49,2.65","2020-05-25,14.20,14.13,14.28,14.04,1110198,1571025184.00,1.69,-0.42,-0.06,1.70","2020-05-26,14.22,14.41,14.49,14.21,1491861,2141513040.00,1.98,1.98,0.28,2.28","2020-05-27,14.39,14.23,14.39,14.12,1098265,1563106416.00,1.87,-1.25,-0.18,1.68","2020-05-28,14.27,14.40,14.64,14.18,1929887,2778933008.00,3.23,1.19,0.17,2.95","2020-05-29,14.25,14.25,14.37,14.16,1241351,1767998032.00,1.46,-1.04,-0.15,1.90","2020-06-01,14.70,15.44,15.60,14.70,4051409,6119991808.00,6.32,8.35,1.19,6.19","2020-06-02,15.30,15.35,15.53,15.17,2348540,3598618576.00,2.33,-0.58,-0.09,3.59","2020-06-03,15.48,15.25,15.65,15.18,2574609,3971931104.00,3.06,-0.65,-0.10,3.93","2020-06-04,15.39,15.25,15.48,15.20,1545104,2364748064.00,1.84,0.00,0.00,2.36","2020-06-05,15.30,15.37,15.40,15.01,2128776,3238126784.00,2.56,0.79,0.12,3.25","2020-06-08,15.36,15.16,15.44,15.13,1604705,2452199136.00,2.02,-1.37,-0.21,2.45","2020-06-09,15.20,15.72,16.12,15.19,3995624,6282682112.00,6.13,3.69,0.56,6.10","2020-06-10,15.67,15.81,15.85,15.56,2002836,3147993616.00,1.84,0.57,0.09,3.06","2020-06-11,15.71,15.81,16.44,15.67,3784165,6048587008.00,4.87,0.00,0.00,5.78","2020-06-12,15.45,16.13,16.28,15.35,3955943,6315334912.00,5.88,2.02,0.32,6.04","2020-06-15,16.28,16.23,16.96,16.12,4696225,7742734592.00,5.21,0.62,0.10,7.18","2020-06-16,16.48,16.50,16.75,16.26,2958863,4879896576.00,3.02,1.66,0.27,4.52","2020-06-17,16.49,16.42,16.55,16.17,2165595,3542020960.00,2.30,-0.48,-0.08,3.31","2020-06-18,16.42,16.95,17.17,16.36,3413248,5742169856.00,4.93,3.23,0.53,5.21","2020-06-19,16.86,18.15,18.58,16.85,5033270,8915026944.00,10.21,7.08,1.20,7.69","2020-06-22,18.31,18.94,19.54,18.20,5150885,9726360320.00,7.38,4.35,0.79,7.87","2020-06-23,18.86,19.61,19.61,18.75,4105510,7868718336.00,4.54,3.54,0.67,6.27","2020-06-24,19.72,19.18,19.77,18.91,3972450,7632609536.00,4.39,-2.19,-0.43,6.07","2020-06-29,18.91,18.50,19.10,18.43,4070772,7619175424.00,3.49,-3.55,-0.68,6.22","2020-06-30,18.71,20.20,20.35,18.66,5034168,9816845824.00,9.14,9.19,1.70,7.69","2020-07-01,20.00,20.24,20.35,19.68,3777696,7562582784.00,3.32,0.20,0.04,5.77","2020-07-02,20.28,21.90,22.17,19.97,5558449,11632698368.00,10.87,8.20,1.66,8.49","2020-07-03,21.92,22.80,23.45,21.63,6477531,14590842112.00,8.31,4.11,0.90,9.90","2020-07-06,23.10,24.80,24.95,22.92,7065356,16949377280.00,8.90,8.77,2.00,10.79","2020-07-07,24.94,23.58,24.98,23.41,6186423,14890056960.00,6.33,-4.92,-1.22,9.45","2020-07-08,23.95,25.94,25.94,23.92,5406811,13399869440.00,8.57,10.01,2.36,8.26","2020-07-09,25.74,27.16,28.18,25.10,6458102,17334089216.00,11.87,4.70,1.22,9.87","2020-07-10,26.15,25.63,26.60,25.58,5372058,13990883584.00,3.76,-5.63,-1.53,8.20","2020-07-13,25.25,26.92,28.11,24.99,5584334,14777072384.00,12.17,5.03,1.29,8.53","2020-07-14,26.69,28.99,29.18,26.20,6098026,16984052480.00,11.07,7.69,2.07,9.31","2020-07-15,28.98,28.02,29.63,27.66,5116369,14551602176.00,6.80,-3.35,-0.97,7.81","2020-07-16,27.55,25.28,28.78,25.22,6353932,17044104448.00,12.71,-9.78,-2.74,9.70","2020-07-17,25.66,24.64,26.05,23.70,5998573,14947851264.00,9.30,-2.53,-0.64,9.16","2020-07-20,25.50,25.80,26.28,24.80,4955148,12651399168.00,6.01,4.71,1.16,7.57","2020-07-21,25.80,25.86,26.55,25.53,3337410,8697677568.00,3.95,0.23,0.06,5.10","2020-07-22,25.88,26.69,27.85,25.88,4768179,12831047168.00,7.62,3.21,0.83,7.28","2020-07-23,26.40,27.53,27.55,26.10,4946598,13302149888.00,5.43,3.15,0.84,7.56","2020-07-24,27.09,25.01,27.18,24.97,6027185,15635154944.00,8.03,-9.15,-2.52,9.21","2020-07-27,25.05,24.84,25.51,24.36,3804887,9481760768.00,4.60,-0.68,-0.17,5.81","2020-07-28,25.59,24.89,25.61,24.51,3284567,8231889152.00,4.43,0.20,0.05,5.02","2020-07-29,24.69,26.70,26.75,24.55,4814257,12477063936.00,8.84,7.27,1.81,7.35","2020-07-30,26.68,26.11,26.68,26.01,3131479,8227913472.00,2.51,-2.21,-0.59,4.78","2020-07-31,26.26,26.67,27.36,26.18,3909435,10465958656.00,4.52,2.14,0.56,5.97","2020-08-03,27.18,27.74,27.86,26.56,4239866,11547596544.00,4.87,4.01,1.07,6.48","2020-08-04,27.68,27.21,27.86,27.05,3179228,8716189440.00,2.92,-1.91,-0.53,4.86","2020-08-05,27.00,27.67,28.27,26.80,3440294,9526855680.00,5.40,1.69,0.46,5.25","2020-08-06,27.79,28.67,29.33,27.09,4265314,11893101312.00,8.10,3.61,1.00,6.51","2020-08-07,27.50,26.93,28.20,26.38,4705861,12807799552.00,6.35,-6.07,-1.74,7.19"]}});'
'''
klinesIndex = data.index("klines")
# print(klinesIndex)
data = data[klinesIndex + 10:-8]
# print(data)
klineDatas = data.split("\",\"")
for i in range(0, len(klineDatas)):
    info = klineDatas[i]
    klineDatas[i] = info.split(",")
insertData(klineDatas)
sys.exit()

